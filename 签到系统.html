<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŸ´æ¡‘äºŒå°ç­¾åˆ°ç³»ç»Ÿ</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            font-family: "Microsoft YaHei", sans-serif; 
        }
        
        body { 
            background: #1e5799; 
            padding: 20px; 
            min-height: 100vh; 
        }
        
        .container { 
            max-width: 400px; 
            margin: 0 auto; 
            background: white; 
            border-radius: 15px; 
            overflow: hidden; 
        }
        
        .header { 
            background: #1e5799; 
            color: white; 
            padding: 25px; 
            text-align: center; 
        }
        
        .school-logo { 
            width: 60px; 
            height: 60px; 
            background: white; 
            border-radius: 50%; 
            margin: 0 auto 10px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 12px; 
            color: #1e5799; 
            font-weight: bold; 
        }
        
        .content { 
            padding: 25px; 
        }
        
        .event-info { 
            background: #f0f7ff; 
            padding: 15px; 
            border-radius: 10px; 
            margin-bottom: 20px; 
            border-left: 4px solid #1e5799; 
        }
        
        .form-group { 
            margin-bottom: 20px; 
        }
        
        .form-group label { 
            display: block; 
            margin-bottom: 8px; 
            color: #333; 
            font-weight: bold; 
        }
        
        .form-group input, 
        .form-group select { 
            width: 100%; 
            padding: 12px; 
            border: 2px solid #ddd; 
            border-radius: 8px; 
            font-size: 16px; 
        }
        
        .btn { 
            background: #1e5799; 
            color: white; 
            border: none; 
            padding: 15px; 
            border-radius: 8px; 
            font-size: 16px; 
            width: 100%; 
            cursor: pointer; 
            margin-top: 10px;
        }
        
        .btn-admin { 
            background: #28a745; 
        }
        
        .btn-secondary { 
            background: #6c757d; 
        }
        
        .result { 
            margin-top: 15px; 
            padding: 12px; 
            border-radius: 6px; 
            text-align: center; 
            display: none; 
        }
        
        .success { 
            background: #d4edda; 
            color: #155724; 
        }
        
        .error { 
            background: #f8d7da; 
            color: #721c24; 
        }
        
        .admin-panel { 
            display: none; 
            margin-top: 20px; 
            padding: 20px; 
            background: #f8f9fa; 
            border-radius: 10px; 
        }
        
        .footer { 
            text-align: center; 
            padding: 15px; 
            background: #f8f9fa; 
            color: #666; 
            font-size: 12px; 
        }
        
        .stats { 
            display: flex; 
            justify-content: space-between; 
            margin: 20px 0; 
            padding: 15px; 
            background: white; 
            border-radius: 10px; 
        }
        
        .stat-item { 
            text-align: center; 
            flex: 1; 
        }
        
        .stat-value { 
            font-size: 20px; 
            font-weight: bold; 
            color: #1e5799; 
        }
        
        .stat-label { 
            font-size: 12px; 
            color: #666; 
            margin-top: 5px; 
        }
        
        .qrcode-section { 
            text-align: center; 
            margin: 20px 0; 
            padding: 20px; 
            background: white; 
            border-radius: 10px; 
        }
        
        .qrcode-container { 
            margin: 15px auto; 
            padding: 15px; 
            background: white; 
            border-radius: 8px; 
            display: inline-block; 
        }
        
        #qrcode { 
            width: 200px; 
            height: 200px; 
        }
        
        .url-display { 
            background: #f8f9fa; 
            border: 1px solid #ddd; 
            border-radius: 6px; 
            padding: 12px; 
            margin: 15px 0; 
            font-size: 12px; 
            word-break: break-all; 
        }
        
        .setting-section { 
            margin-bottom: 20px; 
            padding: 15px; 
            background: white; 
            border-radius: 8px; 
        }
        
        .current-location { 
            background: #e8f4fe; 
            padding: 10px; 
            border-radius: 6px; 
            margin-top: 10px; 
            font-size: 12px; 
        }
        
        .time-info { 
            background: #fff3cd; 
            padding: 10px; 
            border-radius: 6px; 
            margin: 10px 0; 
            font-size: 12px; 
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="school-logo">æŸ´æ¡‘äºŒå°</div>
            <h2>æŸ´æ¡‘åŒºç¬¬äºŒå°å­¦</h2>
            <p>æ•™å¸ˆç­¾åˆ°ç³»ç»Ÿ</p>
        </div>
        
        <div class="content">
            <!-- æ•™å¸ˆç­¾åˆ° -->
            <div id="teacher-view">
                <div class="event-info">
                    <h3 id="event-title">æ•™å¸ˆåŸ¹è®­æ´»åŠ¨</h3>
                    <p id="event-time">2023å¹´10æœˆ15æ—¥ ä¸Šåˆ9:00</p>
                    <p id="event-place">æŸ´æ¡‘åŒºç¬¬äºŒå°å­¦ å¤šåª’ä½“æ•™å®¤</p>
                    <div class="time-info" id="time-check">
                        ğŸ“… æ­£åœ¨æ£€æŸ¥ç­¾åˆ°æ—¶é—´...
                    </div>
                </div>
                
                <div class="form-group">
                    <label>æ•™å¸ˆå§“å</label>
                    <input type="text" id="teacher-name" placeholder="è¯·è¾“å…¥å§“å">
                </div>
                
                <div class="form-group">
                    <label>æ‰€åœ¨éƒ¨é—¨/å¹´çº§</label>
                    <select id="department">
                        <option value="">è¯·é€‰æ‹©</option>
                        <option value="è¯­æ–‡ç»„">è¯­æ–‡ç»„</option>
                        <option value="æ•°å­¦ç»„">æ•°å­¦ç»„</option>
                        <option value="è‹±è¯­ç»„">è‹±è¯­ç»„</option>
                        <option value="ç»¼åˆç»„">ç»¼åˆç»„</option>
                        <option value="ä¸€å¹´çº§">ä¸€å¹´çº§</option>
                        <option value="äºŒå¹´çº§">äºŒå¹´çº§</option>
                        <option value="ä¸‰å¹´çº§">ä¸‰å¹´çº§</option>
                        <option value="å››å¹´çº§">å››å¹´çº§</option>
                        <option value="äº”å¹´çº§">äº”å¹´çº§</option>
                        <option value="å…­å¹´çº§">å…­å¹´çº§</option>
                    </select>
                </div>
                
                <button class="btn" id="signin-btn">ç«‹å³ç­¾åˆ°</button>
                <button class="btn btn-admin" id="admin-btn">ç®¡ç†å‘˜å…¥å£</button>
                
                <div class="result" id="result"></div>
                
                <!-- ç­¾åˆ°ç»Ÿè®¡ -->
                <div class="stats">
                    <div class="stat-item">
                        <div class="stat-value" id="total-teachers">0</div>
                        <div class="stat-label">æ€»äººæ•°</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="signed-teachers">0</div>
                        <div class="stat-label">å·²ç­¾åˆ°</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="signin-rate">0%</div>
                        <div class="stat-label">ç­¾åˆ°ç‡</div>
                    </div>
                </div>
            </div>
            
            <!-- ç®¡ç†å‘˜ -->
            <div id="admin-view" class="admin-panel">
                <h3 style="text-align:center; margin-bottom:20px; color:#1e5799;">ç®¡ç†é¢æ¿</h3>
                
                <div class="form-group">
                    <label>æ´»åŠ¨åç§°</label>
                    <input type="text" id="set-event-name" value="æ•™å¸ˆåŸ¹è®­æ´»åŠ¨">
                </div>
                
                <div class="form-group">
                    <label>æ´»åŠ¨æ—¥æœŸ</label>
                    <input type="date" id="set-event-date" value="2023-10-15">
                </div>
                
                <div class="form-group">
                    <label>æ´»åŠ¨å¼€å§‹æ—¶é—´</label>
                    <input type="time" id="set-event-start-time" value="09:00">
                </div>
                
                <div class="form-group">
                    <label>æ´»åŠ¨åœ°ç‚¹</label>
                    <input type="text" id="set-event-place" value="æŸ´æ¡‘åŒºç¬¬äºŒå°å­¦ å¤šåª’ä½“æ•™å®¤">
                </div>
                
                <!-- ä½ç½®ç­¾åˆ°è®¾ç½® -->
                <div class="setting-section">
                    <h4>ğŸ“ ä½ç½®ç­¾åˆ°è®¾ç½®</h4>
                    <div class="form-group">
                        <label>ç­¾åˆ°èŒƒå›´ (ç±³)</label>
                        <input type="number" id="location-range" value="500" min="100" max="5000">
                    </div>
                    <div class="form-group">
                        <label>å½“å‰ä½ç½®åæ ‡</label>
                        <div class="current-location">
                            <div>çº¬åº¦: <span id="current-lat">æ­£åœ¨è·å–...</span></div>
                            <div>ç»åº¦: <span id="current-lng">æ­£åœ¨è·å–...</span></div>
                        </div>
                        <button class="btn btn-secondary" id="set-current-location">ä½¿ç”¨å½“å‰ä½ç½®</button>
                    </div>
                    <div class="form-group">
                        <label>ç›®æ ‡çº¬åº¦</label>
                        <input type="number" id="target-lat" step="any" placeholder="ä¾‹å¦‚: 29.123456">
                    </div>
                    <div class="form-group">
                        <label>ç›®æ ‡ç»åº¦</label>
                        <input type="number" id="target-lng" step="any" placeholder="ä¾‹å¦‚: 115.123456">
                    </div>
                </div>

                <!-- WiFiç­¾åˆ°è®¾ç½® -->
                <div class="setting-section">
                    <h4>ğŸ“¶ WiFiç­¾åˆ°è®¾ç½®</h4>
                    <div class="form-group">
                        <label>WiFiåç§° (SSID)</label>
                        <input type="text" id="wifi-name" placeholder="ä¾‹å¦‚: Chaisang-School">
                    </div>
                    <div class="form-group">
                        <label>WiFi BSSID (å¯é€‰)</label>
                        <input type="text" id="wifi-bssid" placeholder="ä¾‹å¦‚: 00:11:22:33:44:55">
                    </div>
                </div>

                <!-- ç­¾åˆ°æ–¹å¼è®¾ç½® -->
                <div class="setting-section">
                    <h4>âš™ï¸ ç­¾åˆ°æ–¹å¼è®¾ç½®</h4>
                    <div class="form-group">
                        <label>ç­¾åˆ°éªŒè¯æ–¹å¼</label>
                        <select id="signin-method">
                            <option value="location">ä»…ä½ç½®ç­¾åˆ°</option>
                            <option value="wifi">ä»…WiFiç­¾åˆ°</option>
                            <option value="both">ä½ç½®æˆ–WiFiå‡å¯</option>
                            <option value="none">æ— éœ€éªŒè¯</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>æ•™å¸ˆåå•ï¼ˆæ¯è¡Œä¸€ä¸ªå§“åï¼‰</label>
                    <textarea id="teacher-list" rows="4" placeholder="å¼ ä¸‰&#10;æå››&#10;ç‹äº”"></textarea>
                </div>
                
                <!-- äºŒç»´ç ç”Ÿæˆéƒ¨åˆ† -->
                <div class="qrcode-section">
                    <h4>ğŸ“± ç­¾åˆ°äºŒç»´ç </h4>
                    <div class="qrcode-container">
                        <div id="qrcode"></div>
                    </div>
                    <div class="url-display">
                        <strong>ç­¾åˆ°é“¾æ¥:</strong><br>
                        <span id="current-url">æ­£åœ¨ç”Ÿæˆ...</span>
                    </div>
                    <button class="btn" id="generate-qrcode">ç”ŸæˆäºŒç»´ç </button>
                    <button class="btn btn-secondary" id="copy-url">å¤åˆ¶é“¾æ¥</button>
                    <p style="font-size:12px; color:#666; margin-top:10px;">
                        æ•™å¸ˆæ‰«æä¸Šæ–¹äºŒç»´ç å³å¯ç­¾åˆ°<br>
                        å»ºè®®ä¿å­˜äºŒç»´ç å›¾ç‰‡æ‰“å°ä½¿ç”¨
                    </p>
                </div>
                
                <button class="btn" id="save-settings">ä¿å­˜è®¾ç½®</button>
                <button class="btn" id="export-data">å¯¼å‡ºç­¾åˆ°æ•°æ®</button>
                <button class="btn btn-admin" id="exit-admin">è¿”å›ç­¾åˆ°</button>
            </div>
        </div>
        
        <div class="footer">
            <p>æŸ´æ¡‘åŒºç¬¬äºŒå°å­¦ Â© 2023 | æŠ€æœ¯æ”¯æŒ: ä¿¡æ¯ä¸­å¿ƒ</p>
        </div>
    </div>

    <script>
        // ç®¡ç†å‘˜å¯†ç 
        const ADMIN_PASSWORD = "13755262970";
        
        // åˆå§‹åŒ–ç³»ç»Ÿ
        document.addEventListener('DOMContentLoaded', function() {
            // ç»‘å®šäº‹ä»¶
            document.getElementById('signin-btn').addEventListener('click', signIn);
            document.getElementById('admin-btn').addEventListener('click', showAdmin);
            document.getElementById('exit-admin').addEventListener('click', showTeacher);
            document.getElementById('save-settings').addEventListener('click', saveSettings);
            document.getElementById('export-data').addEventListener('click', exportData);
            document.getElementById('generate-qrcode').addEventListener('click', generateQRCode);
            document.getElementById('copy-url').addEventListener('click', copyURL);
            document.getElementById('set-current-location').addEventListener('click', setCurrentLocation);
            
            // åˆå§‹åŒ–åŠŸèƒ½
            loadSettings();
            updateStats();
            checkSigninTime();
            getLocation();
            
            // æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡ç­¾åˆ°æ—¶é—´
            setInterval(checkSigninTime, 60000);
        });

        // æ£€æŸ¥ç­¾åˆ°æ—¶é—´
        function checkSigninTime() {
            const eventSettings = getEventSettings();
            const eventDate = eventSettings.date;
            const eventTime = eventSettings.startTime || "09:00";
            
            // æ„å»ºæ´»åŠ¨å¼€å§‹æ—¶é—´
            const eventDateTime = new Date(`${eventDate}T${eventTime}:00`);
            const now = new Date();
            
            // è®¡ç®—æ—¶é—´å·®ï¼ˆåˆ†é’Ÿï¼‰
            const timeDiff = (now - eventDateTime) / (1000 * 60);
            
            const timeCheck = document.getElementById('time-check');
            const signinBtn = document.getElementById('signin-btn');
            
            if (timeDiff < 0) {
                // æ´»åŠ¨æœªå¼€å§‹
                const minutesLeft = Math.abs(Math.floor(timeDiff));
                timeCheck.innerHTML = `â° æ´»åŠ¨å°šæœªå¼€å§‹ï¼Œè¿˜æœ‰ ${minutesLeft} åˆ†é’Ÿ`;
                timeCheck.style.background = '#fff3cd';
                signinBtn.disabled = true;
                signinBtn.style.background = '#6c757d';
            } else if (timeDiff <= 30) {
                // åœ¨30åˆ†é’Ÿå†…
                const minutesLeft = 30 - Math.floor(timeDiff);
                timeCheck.innerHTML = `âœ… å¯ç­¾åˆ°ï¼Œå‰©ä½™æ—¶é—´ ${minutesLeft} åˆ†é’Ÿ`;
                timeCheck.style.background = '#d4edda';
                signinBtn.disabled = false;
                signinBtn.style.background = '#1e5799';
            } else {
                // è¶…è¿‡30åˆ†é’Ÿ
                timeCheck.innerHTML = 'âŒ ç­¾åˆ°æ—¶é—´å·²è¿‡ï¼ˆè¶…è¿‡30åˆ†é’Ÿï¼‰';
                timeCheck.style.background = '#f8d7da';
                signinBtn.disabled = true;
                signinBtn.style.background = '#6c757d';
            }
        }

        // æ˜¾ç¤ºæ•™å¸ˆç•Œé¢
        function showTeacher() {
            document.getElementById('teacher-view').style.display = 'block';
            document.getElementById('admin-view').style.display = 'none';
            localStorage.setItem('isAdmin', 'false');
            checkSigninTime();
        }
        
        // æ˜¾ç¤ºç®¡ç†å‘˜ç•Œé¢
        function showAdmin() {
            const password = prompt('è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç ï¼š');
            if (password === ADMIN_PASSWORD) {
                document.getElementById('teacher-view').style.display = 'none';
                document.getElementById('admin-view').style.display = 'block';
                localStorage.setItem('isAdmin', 'true');
                loadAdminSettings();
                generateQRCode();
                getLocation();
            } else {
                alert('å¯†ç é”™è¯¯ï¼');
            }
        }
        
        // è·å–åœ°ç†ä½ç½®
        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        // æ›´æ–°ç®¡ç†å‘˜ç•Œé¢çš„å½“å‰ä½ç½®æ˜¾ç¤º
                        document.getElementById('current-lat').textContent = lat.toFixed(6);
                        document.getElementById('current-lng').textContent = lng.toFixed(6);
                    },
                    function(error) {
                        console.log('ä½ç½®è·å–å¤±è´¥:', error);
                    }
                );
            }
        }
        
        // è®¾ç½®å½“å‰ä½ç½®ä¸ºç­¾åˆ°ç‚¹
        function setCurrentLocation() {
            const currentLat = document.getElementById('current-lat').textContent;
            const currentLng = document.getElementById('current-lng').textContent;
            
            if (currentLat !== 'æ­£åœ¨è·å–...' && currentLng !== 'æ­£åœ¨è·å–...') {
                document.getElementById('target-lat').value = currentLat;
                document.getElementById('target-lng').value = currentLng;
                showResult('å½“å‰ä½ç½®å·²è®¾ç½®ä¸ºç­¾åˆ°ç‚¹ï¼', 'success');
            } else {
                showResult('è¯·ç­‰å¾…ä½ç½®ä¿¡æ¯è·å–å®Œæˆåå†è®¾ç½®ã€‚', 'error');
            }
        }
        
        // ç”ŸæˆäºŒç»´ç 
        function generateQRCode() {
            try {
                // è·å–å½“å‰é¡µé¢URLï¼ˆä¸å¸¦å‚æ•°ï¼‰
                const currentUrl = window.location.origin + window.location.pathname;
                document.getElementById('current-url').textContent = currentUrl;
                
                // æ¸…ç©ºä¹‹å‰çš„äºŒç»´ç 
                document.getElementById('qrcode').innerHTML = '';
                
                // ç”Ÿæˆæ–°çš„äºŒç»´ç 
                QRCode.toCanvas(document.getElementById('qrcode'), currentUrl, 
                    {
                        width: 200,
                        height: 200,
                        margin: 1,
                        color: {
                            dark: '#1e5799',
                            light: '#ffffff'
                        }
                    }, 
                    function(error) {
                        if (error) {
                            console.error('äºŒç»´ç ç”Ÿæˆå¤±è´¥:', error);
                            document.getElementById('qrcode').innerHTML = 
                                '<div style="color:red; text-align:center; padding:20px;">äºŒç»´ç ç”Ÿæˆå¤±è´¥<br>è¯·åˆ·æ–°é¡µé¢é‡è¯•</div>';
                        } else {
                            showResult('äºŒç»´ç ç”ŸæˆæˆåŠŸï¼', 'success');
                        }
                    }
                );
            } catch (error) {
                console.error('äºŒç»´ç ç”Ÿæˆé”™è¯¯:', error);
                document.getElementById('qrcode').innerHTML = 
                    '<div style="color:red; text-align:center; padding:20px;">äºŒç»´ç åŠŸèƒ½åŠ è½½ä¸­<br>è¯·ç¨åé‡è¯•</div>';
            }
        }
        
        // å¤åˆ¶é“¾æ¥
        function copyURL() {
            const url = document.getElementById('current-url').textContent;
            navigator.clipboard.writeText(url).then(function() {
                showResult('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼', 'success');
            }).catch(function() {
                // å¤‡ç”¨æ–¹æ¡ˆ
                const textArea = document.createElement('textarea');
                textArea.value = url;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showResult('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼', 'success');
            });
        }
        
        // ç­¾åˆ°åŠŸèƒ½
        function signIn() {
            // æ£€æŸ¥ç­¾åˆ°æ—¶é—´
            const eventSettings = getEventSettings();
            const eventDateTime = new Date(`${eventSettings.date}T${eventSettings.startTime || "09:00"}:00`);
            const now = new Date();
            const timeDiff = (now - eventDateTime) / (1000 * 60);
            
            if (timeDiff > 30) {
                showResult('ç­¾åˆ°æ—¶é—´å·²è¿‡ï¼ˆè¶…è¿‡30åˆ†é’Ÿï¼‰', 'error');
                return;
            }
            
            const name = document.getElementById('teacher-name').value.trim();
            const dept = document.getElementById('department').value;
            
            if (!name) {
                showResult('è¯·è¾“å…¥å§“å', 'error');
                return;
            }
            
            if (!dept) {
                showResult('è¯·é€‰æ‹©éƒ¨é—¨/å¹´çº§', 'error');
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦é‡å¤ç­¾åˆ°
            const signData = getSignData();
            const today = new Date().toDateString();
            const hasSignedToday = signData.some(item => 
                item.name === name && 
                new Date(item.time).toDateString() === today
            );
            
            if (hasSignedToday) {
                showResult(`${name}è€å¸ˆï¼Œæ‚¨ä»Šå¤©å·²ç»ç­¾åˆ°è¿‡äº†ï¼`, 'error');
                return;
            }
            
            // æ£€æŸ¥æ•™å¸ˆåå•
            const teacherList = localStorage.getItem('teacherList');
            if (teacherList) {
                const teachers = teacherList.split('\n').map(t => t.trim());
                if (!teachers.includes(name)) {
                    showResult('å§“åä¸åœ¨æ•™å¸ˆåå•ä¸­', 'error');
                    return;
                }
            }
            
            // éªŒè¯ç­¾åˆ°æ¡ä»¶
            const signinMethod = localStorage.getItem('signinMethod') || 'none';
            let isValid = true;
            let errorMessage = '';
            
            if (signinMethod !== 'none') {
                isValid = false;
                errorMessage = 'ç­¾åˆ°éªŒè¯å¤±è´¥ï¼š';
                
                if (signinMethod === 'location' || signinMethod === 'both') {
                    // ä½ç½®éªŒè¯
                    const locationSettings = JSON.parse(localStorage.getItem('locationSettings') || '{}');
                    if (locationSettings.targetLat && locationSettings.targetLng) {
                        // æ¨¡æ‹Ÿä½ç½®éªŒè¯
                        if (Math.random() > 0.2) {
                            isValid = true;
                        } else {
                            errorMessage += 'ä¸åœ¨ç­¾åˆ°èŒƒå›´å†…ï¼›';
                        }
                    }
                }
                
                if (!isValid && (signinMethod === 'wifi' || signinMethod === 'both')) {
                    // WiFiéªŒè¯
                    const wifiSettings = JSON.parse(localStorage.getItem('wifiSettings') || '{}');
                    if (wifiSettings.wifiName) {
                        // æ¨¡æ‹ŸWiFiéªŒè¯
                        if (Math.random() > 0.2) {
                            isValid = true;
                        } else {
                            errorMessage += 'æœªè¿æ¥åˆ°æŒ‡å®šWiFiï¼›';
                        }
                    }
                }
            }
            
            if (isValid) {
                // è·å–å½“å‰æ´»åŠ¨ä¿¡æ¯
                const eventSettings = getEventSettings();
                
                // ä¿å­˜ç­¾åˆ°è®°å½•
                const signRecord = {
                    name: name,
                    department: dept,
                    time: new Date().toLocaleString('zh-CN'),
                    event: eventSettings.name,
                    date: eventSettings.date,
                    location: eventSettings.location,
                    timestamp: new Date().getTime(),
                    signinMethod: signinMethod
                };
                
                saveSignData(signRecord);
                showResult(`${name}è€å¸ˆç­¾åˆ°æˆåŠŸï¼`, 'success');
                document.getElementById('teacher-name').value = '';
                document.getElementById('department').value = '';
                updateStats();
            } else {
                showResult(errorMessage, 'error');
            }
        }
        
        // æ˜¾ç¤ºç»“æœ
        function showResult(message, type) {
            const result = document.getElementById('result');
            result.textContent = message;
            result.className = `result ${type}`;
            result.style.display = 'block';
            setTimeout(() => {
                result.style.display = 'none';
            }, 3000);
        }
        
        // ä¿å­˜è®¾ç½®
        function saveSettings() {
            const eventName = document.getElementById('set-event-name').value;
            const eventDate = document.getElementById('set-event-date').value;
            const eventStartTime = document.getElementById('set-event-start-time').value;
            const eventPlace = document.getElementById('set-event-place').value;
            const teacherList = document.getElementById('teacher-list').value;
            
            // ä¿å­˜æ´»åŠ¨è®¾ç½®
            const eventSettings = {
                name: eventName,
                date: eventDate,
                startTime: eventStartTime,
                location: eventPlace,
                lastModified: new Date().getTime()
            };
            localStorage.setItem('eventSettings', JSON.stringify(eventSettings));
            
            // ä¿å­˜ä½ç½®è®¾ç½®
            const locationSettings = {
                range: document.getElementById('location-range').value,
                targetLat: document.getElementById('target-lat').value,
                targetLng: document.getElementById('target-lng').value
            };
            localStorage.setItem('locationSettings', JSON.stringify(locationSettings));
            
            // ä¿å­˜WiFiè®¾ç½®
            const wifiSettings = {
                wifiName: document.getElementById('wifi-name').value,
                wifiBSSID: document.getElementById('wifi-bssid').value
            };
            localStorage.setItem('wifiSettings', JSON.stringify(wifiSettings));
            
            // ä¿å­˜ç­¾åˆ°æ–¹å¼
            const signinMethod = document.getElementById('signin-method').value;
            localStorage.setItem('signinMethod', signinMethod);
            
            // ä¿å­˜æ•™å¸ˆåå•
            localStorage.setItem('teacherList', teacherList);
            
            // æ›´æ–°æ˜¾ç¤º
            updateEventDisplay(eventSettings);
            showResult('è®¾ç½®å·²ä¿å­˜ï¼', 'success');
            updateStats();
            checkSigninTime();
            
            // é‡æ–°ç”ŸæˆäºŒç»´ç 
            generateQRCode();
        }
        
        // åŠ è½½è®¾ç½®
        function loadSettings() {
            const eventSettings = getEventSettings();
            updateEventDisplay(eventSettings);
        }
        
        // åŠ è½½ç®¡ç†å‘˜è®¾ç½®
        function loadAdminSettings() {
            const eventSettings = getEventSettings();
            document.getElementById('set-event-name').value = eventSettings.name;
            document.getElementById('set-event-date').value = eventSettings.date;
            document.getElementById('set-event-start-time').value = eventSettings.startTime || "09:00";
            document.getElementById('set-event-place').value = eventSettings.location;
            
            const teacherList = localStorage.getItem('teacherList');
            if (teacherList) {
                document.getElementById('teacher-list').value = teacherList;
            }
            
            // åŠ è½½ä½ç½®è®¾ç½®
            const locationSettings = JSON.parse(localStorage.getItem('locationSettings') || '{}');
            document.getElementById('location-range').value = locationSettings.range || 500;
            document.getElementById('target-lat').value = locationSettings.targetLat || '';
            document.getElementById('target-lng').value = locationSettings.targetLng || '';
            
            // åŠ è½½WiFiè®¾ç½®
            const wifiSettings = JSON.parse(localStorage.getItem('wifiSettings') || '{}');
            document.getElementById('wifi-name').value = wifiSettings.wifiName || '';
            document.getElementById('wifi-bssid').value = wifiSettings.wifiBSSID || '';
            
            // åŠ è½½ç­¾åˆ°æ–¹å¼
            const signinMethod = localStorage.getItem('signinMethod') || 'none';
            document.getElementById('signin-method').value = signinMethod;
        }
        
        // è·å–æ´»åŠ¨è®¾ç½®
        function getEventSettings() {
            const defaultSettings = {
                name: "æ•™å¸ˆåŸ¹è®­æ´»åŠ¨",
                date: "2023-10-15",
                startTime: "09:00",
                location: "æŸ´æ¡‘åŒºç¬¬äºŒå°å­¦ å¤šåª’ä½“æ•™å®¤"
            };
            
            const saved = localStorage.getItem('eventSettings');
            return saved ? JSON.parse(saved) : defaultSettings;
        }
        
        // æ›´æ–°æ´»åŠ¨æ˜¾ç¤º
        function updateEventDisplay(settings) {
            document.getElementById('event-title').textContent = settings.name;
            document.getElementById('event-time').textContent = formatDate(settings.date) + ' ä¸Šåˆ' + (settings.startTime || "09:00");
            document.getElementById('event-place').textContent = settings.location;
        }
        
        // è·å–ç­¾åˆ°æ•°æ®
        function getSignData() {
            const saved = localStorage.getItem('signData');
            return saved ? JSON.parse(saved) : [];
        }
        
        // ä¿å­˜ç­¾åˆ°æ•°æ®
        function saveSignData(record) {
            const allData = getSignData();
            allData.push(record);
            localStorage.setItem('signData', JSON.stringify(allData));
        }
        
        // æ›´æ–°ç»Ÿè®¡
        function updateStats() {
            const teacherList = localStorage.getItem('teacherList');
            const teachers = teacherList ? teacherList.split('\n').filter(name => name.trim() !== '') : [];
            const signData = getSignData();
            const signedTeachers = [...new Set(signData.map(item => item.name))];
            
            document.getElementById('total-teachers').textContent = teachers.length;
            document.getElementById('signed-teachers').textContent = signedTeachers.length;
            const rate = teachers.length > 0 ? Math.round((signedTeachers.length / teachers.length) * 100) : 0;
            document.getElementById('signin-rate').textContent = rate + '%';
        }
        
        // å¯¼å‡ºæ•°æ®
        function exportData() {
            const signData = getSignData();
            if (signData.length === 0) {
                showResult('æš‚æ— ç­¾åˆ°æ•°æ®', 'error');
                return;
            }
            
            // è½¬æ¢ä¸ºCSVæ ¼å¼
            let csv = 'å§“å,éƒ¨é—¨,ç­¾åˆ°æ—¶é—´,æ´»åŠ¨åç§°,æ´»åŠ¨æ—¥æœŸ,æ´»åŠ¨åœ°ç‚¹,ç­¾åˆ°æ–¹å¼\n';
            signData.forEach(item => {
                csv += `"${item.name}","${item.department}","${item.time}","${item.event}","${formatDate(item.date)}","${item.location}","${item.signinMethod}"\n`;
            });
            
            const blob = new Blob(['\uFEFF' + csv], {type: 'text/csv;charset=utf-8;'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `æŸ´æ¡‘äºŒå°ç­¾åˆ°è®°å½•_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showResult('ç­¾åˆ°æ•°æ®å·²å¯¼å‡ºä¸ºCSVæ–‡ä»¶', 'success');
        }
        
        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return `${date.getFullYear()}å¹´${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥`;
        }
    </script>
</body>
</html>